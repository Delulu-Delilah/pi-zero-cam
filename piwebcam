#!/usr/bin/env bash
# ============================================================================
#  piwebcam — IP Camera Launcher for Pi Zero Cam
#
#  Starts MediaMTX and streams video from the camera via RTSP/WebRTC.
#  Called automatically by piwebcam.service on boot.
# ============================================================================
set -euo pipefail

# ── Logging ─────────────────────────────────────────────────────────────────
log()  { echo "[piwebcam] $*" | logger -t piwebcam; echo "[piwebcam] $*"; }
die()  { log "FATAL: $*"; exit 1; }

cleanup() {
    log "Shutting down..."
    kill $(jobs -p) 2>/dev/null || true
    log "Processes stopped"
}
trap cleanup EXIT SIGTERM SIGINT

# ── Find the best video device ─────────────────────────────────────────────
find_camera_device() {
    local best_dev=""
    for dev in /dev/video*; do
        [[ -e "$dev" ]] || continue
        if v4l2-ctl --device="$dev" --all 2>/dev/null | grep -q "Video Capture"; then
            local caps
            caps=$(v4l2-ctl --device="$dev" --all 2>/dev/null | grep "Driver name" | head -1 || true)
            if echo "$caps" | grep -qi "unicam\|bcm2835\|mmal"; then
                best_dev="$dev"
                log "Found CSI camera on $dev" >&2
                break
            elif [[ -z "$best_dev" ]]; then
                best_dev="$dev"
                log "Found capture device on $dev" >&2
            fi
        fi
    done
    echo "$best_dev"
}

# ── Main ────────────────────────────────────────────────────────────────────
main() {
    log "Starting Pi Zero IP Camera..."

    # Wait a moment for video devices to initialize
    sleep 2

    local cam_dev
    cam_dev=$(find_camera_device)
    if [[ -z "$cam_dev" ]]; then
        die "No camera device found. Check your camera connection."
    fi
    log "Using camera: $cam_dev"

    log "Starting MediaMTX RTSP/WebRTC Server..."
    /usr/local/bin/mediamtx &
    sleep 2

    # Check for libcamera or rpicam (renamed in modern Pi OS)
    local cam_app=""
    if command -v rpicam-vid &>/dev/null; then
        cam_app="rpicam-vid"
    elif command -v libcamera-vid &>/dev/null; then
        cam_app="libcamera-vid"
    fi

    if [[ -n "$cam_app" ]]; then
        log "Streaming via $cam_app..."
        
        # We pipe output (H264 bitstream) to ffmpeg to package it as RTSP
        # RTSP stream will be available at rtsp://<ip>:8554/cam
        # WebRTC stream will be available at http://<ip>:8889/cam
        "$cam_app" -t 0 --inline --framerate 30 \
            --codec h264 --profile high --level 4.2 \
            -o - | ffmpeg -hide_banner -loglevel error \
            -f h264 -i - -c:v copy \
            -rtsp_transport tcp -f rtsp rtsp://localhost:8554/cam &
            
    elif command -v ffmpeg &>/dev/null; then
        log "Streaming via ffmpeg (V4L2)..."
        ffmpeg -hide_banner -loglevel error \
            -f v4l2 -framerate 30 -video_size 1280x720 -i "$cam_dev" \
            -c:v libx264 -preset ultrafast -tune zerolatency \
            -rtsp_transport tcp -f rtsp rtsp://localhost:8554/cam &
    else
        die "Neither libcamera-vid nor ffmpeg is installed."
    fi

    log "Streaming active! Watch at http://<pi-ip>:8889/cam"
    
    # Keep the script running to keep background jobs alive
    wait
}

main "$@"
