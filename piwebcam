#!/usr/bin/env bash
# ============================================================================
#  piwebcam — IP Camera Launcher for Pi Zero Cam
#
#  Starts MediaMTX and streams video from the camera via RTSP/WebRTC.
#  Called automatically by piwebcam.service on boot.
# ============================================================================
set -euo pipefail

# ── Logging ─────────────────────────────────────────────────────────────────
log()  { echo "[piwebcam] $*" | logger -t piwebcam; echo "[piwebcam] $*"; }
die()  { log "FATAL: $*"; exit 1; }

cleanup() {
    log "Shutting down..."
    kill $(jobs -p) 2>/dev/null || true
    log "Processes stopped"
}
trap cleanup EXIT SIGTERM SIGINT

# ── Find the best video device ─────────────────────────────────────────────
find_camera_device() {
    local best_dev=""
    for dev in /dev/video*; do
        [[ -e "$dev" ]] || continue
        if v4l2-ctl --device="$dev" --all 2>/dev/null | grep -q "Video Capture"; then
            local caps
            caps=$(v4l2-ctl --device="$dev" --all 2>/dev/null | grep "Driver name" | head -1 || true)
            if echo "$caps" | grep -qi "unicam\|bcm2835\|mmal"; then
                best_dev="$dev"
                log "Found CSI camera on $dev" >&2
                break
            elif [[ -z "$best_dev" ]]; then
                best_dev="$dev"
                log "Found capture device on $dev" >&2
            fi
        fi
    done
    echo "$best_dev"
}

# ── Main ────────────────────────────────────────────────────────────────────
main() {
    log "Starting Pi Zero IP Camera..."

    # Wait a moment for video devices to initialize
    sleep 2

    local cam_dev
    cam_dev=$(find_camera_device)
    if [[ -z "$cam_dev" ]]; then
        die "No camera device found. Check your camera connection."
    fi
    log "Using camera: $cam_dev"

    log "Configuring MediaMTX for native Raspberry Pi Camera..."
    
    cat <<EOF > /tmp/mediamtx.yml
paths:
  cam:
    source: rpiCamera
    rpiCameraWidth: 1280
    rpiCameraHeight: 720
EOF

    log "Starting MediaMTX RTSP/WebRTC Server..."
    log "Streaming active! Watch at http://<pi-ip>:8889/cam"
    
    # Run MediaMTX in the foreground with our config
    exec /usr/local/bin/mediamtx /tmp/mediamtx.yml
}

main "$@"
